# Ralph Progress Log
## Codebase Patterns
<!-- Reusable patterns discovered across iterations — update this section, don't append -->

- **WorkflowStep model**: `Models/WorkflowStep.cs` — record-like class with `StepIndex`, `Title`, `Category`, `Icon` (all `init`-only)
- **ViewModel pattern**: `HedgingDiagramViewModel` exposes both `IReadOnlyList<string> Nodes` (legacy) and `IReadOnlyList<WorkflowStep> WorkflowSteps`
- **Categories**: data-input, processing, approval, output — map to Material Design color palette
- **CSS files**: `wwwroot/css/app.css` (layout, components, design tokens in :root), `wwwroot/css/hedging.css` (diagram grid, nodes)
- **CSS custom properties**: All design tokens defined in `:root` block of app.css — colors, spacing, shadows, radii. Always use `var(--token)` instead of hardcoded values.
- **E2E test base**: `AppPageTest` class with `BaseUrl` from `TEST_BASE_URL` env var (default localhost:5000)
- **E2E test pattern**: `EvaluateAsync<string>("el => window.getComputedStyle(el).propertyName")` for CSS assertions
- **NuGet packages**: Main app uses `Z.Blazor.Diagrams` (not `Blazor.Diagrams`) v3.0.4; namespace is still `Blazor.Diagrams`. Radzen.Blazor resolves to 4.31.0.
- **Z.Blazor.Diagrams v3 API**: `Diagram` renamed to `BlazorDiagram`, `<BlazorDiagram>` component → `<DiagramCanvas BlazorDiagram="@diagram" />`, `GetDefaultPort()` removed — use `Ports.First(p => p.Alignment == ...)` instead
- **File upload**: Use standard Blazor `InputFile` with `InputFileChangeEventArgs` (not Radzen `RadzenFileInput`/`FileInputChangeEventArgs`)
- **IHedgingWizardViewModel.Step**: Has `{ get; set; }` — setter needed for `@bind-Value` in RadzenSteps
- **Design skill**: `.claude/skills/design/SKILL.md` — comprehensive design system tokens (colors, spacing, typography, components)
- **Wizard step numbering**: Steps 0-8 rendered via `Vm.Step switch` in HedgingWizard.razor; note steps 7/8 are Reporting/Booking (swapped from expected order)
- **Approval gate**: Approver rows found via exact text match + XPath ancestor::tr[1]; Approve button disabled after click confirms state change
- **Unit tests**: `dotnet test Pemberton.Shareclass.Hedging.Prototype/tests/Pemberton.Shareclass.Hedging.Prototype.Tests/`
- **E2E tests**: `dotnet test Pemberton.Shareclass.Hedging.Prototype/tests/Pemberton.Shareclass.Hedging.Prototype.UITests/`

---
<!-- Iteration logs below — always append, never replace -->

## 2026-02-22 - US-001: Create the Professional Web Design AI Skill
- Created `.claude/skills/design/SKILL.md` with YAML frontmatter and all 8 required sections
- Fixed pre-existing doubled-quote corruption (`""` → `"`) across 18 source files (all .cs, .razor, .cshtml, .css)
- Fixed NuGet package: `Blazor.Diagrams` → `Z.Blazor.Diagrams` v3.0.4 (net8.0 target)
- Fixed .csproj files: doubled quotes in XML attributes
- Updated HedgingDiagram.razor for Z.Blazor.Diagrams v3 API (BlazorDiagram, DiagramCanvas, port lookup)
- Replaced `RadzenFileInput`/`Radzen.FileInputChangeEventArgs` with standard `InputFile`/`InputFileChangeEventArgs`
- Added `@using Microsoft.AspNetCore.Components.Forms` and `@using Microsoft.AspNetCore.Components.Routing` to _Imports.razor
- Made `IHedgingWizardViewModel.Step` settable (needed for `@bind-Value`)
- Files changed: 23 files (SKILL.md, 2 .csproj, 12 src .cs/.razor/.cshtml/.css, 3 test .cs, _Imports.razor, IHedgingWizardViewModel.cs, HedgingDiagram.razor)
- **Learnings for future iterations:**
  - The codebase on main had systematic doubled-quote corruption — all fixed now
  - Z.Blazor.Diagrams v3 has breaking API changes from v2 (Diagram→BlazorDiagram, different component names, removed GetDefaultPort)
  - Radzen 4.31 doesn't have `FileInputChangeEventArgs` — use standard Blazor `InputFileChangeEventArgs` instead
  - The `@bind-Value` on RadzenSteps requires a settable property on the interface

## 2026-02-23 - US-002: Establish CSS Design Token Foundation
- Added Google Fonts preconnect hints (`fonts.googleapis.com`, `fonts.gstatic.com`) and Inter font link (weights 400, 500, 600) to `_Host.cshtml`
- Created comprehensive `:root` block in `app.css` with all CSS custom properties from design skill: brand/accent colors, semantic colors, surfaces, category colors, text colors, spacing (--space-1 through --space-12), shadows, border radii
- Updated `body` font-family to `'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`
- Replaced all hardcoded hex values in `app.css`: sidebar bg → `var(--surface-sidebar)`, text → `var(--text-on-dark)`, active/hover color → `var(--color-accent)`, main bg → `var(--surface-body)`, topbar → `var(--surface-topbar)`, border → `var(--surface-border)`, border-radius → `var(--radius-sm)`
- Replaced all hardcoded values in `hedging.css`: grid gap/margin/padding → spacing tokens, arrow color → `var(--text-secondary)`, node padding/radius/gap → tokens, shadows → `var(--shadow-md)`/`var(--shadow-lg)`, category backgrounds → `var(--category-*)` tokens
- Updated `NavigationTests.cs`: `ActiveLink_HasHighlightColor` expects `rgb(14, 165, 233)` (was `rgb(97, 218, 251)`)
- Updated `DiagramPageTests.cs`: `Nodes_HaveCategoryBackgroundColors` expects new RGB values matching design tokens
- Files changed: `_Host.cshtml`, `app.css`, `hedging.css`, `NavigationTests.cs`, `DiagramPageTests.cs`
- **Learnings for future iterations:**
  - CSS variable values intentionally differ from old hardcoded values — E2E tests checking computed colors MUST be updated when design tokens change
  - The `:root` block is the single source of truth for all design tokens; future CSS should reference `var(--token)` exclusively
  - Resolved pre-existing merge conflict state on `prd.json` and `progress.txt` — files had unmerged status but no actual conflict markers
