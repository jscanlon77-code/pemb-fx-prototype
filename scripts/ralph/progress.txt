# Ralph Progress Log
## Codebase Patterns
<!-- Reusable patterns discovered across iterations — update this section, don't append -->

- **WorkflowStep model**: `Models/WorkflowStep.cs` — record-like class with `StepIndex`, `Title`, `Category`, `Icon` (all `init`-only)
- **ViewModel pattern**: `HedgingDiagramViewModel` exposes both `IReadOnlyList<string> Nodes` (legacy) and `IReadOnlyList<WorkflowStep> WorkflowSteps`
- **Categories**: data-input, processing, approval, output — map to Material Design color palette
- **CSS files**: `wwwroot/css/app.css` (layout, components, design tokens in :root), `wwwroot/css/hedging.css` (diagram grid, nodes)
- **CSS custom properties**: All design tokens defined in `:root` block of app.css — colors, spacing, shadows, radii. Always use `var(--token)` instead of hardcoded values.
- **E2E test base**: `AppPageTest` class with `BaseUrl` from `TEST_BASE_URL` env var (default localhost:5000)
- **E2E test pattern**: `EvaluateAsync<string>("el => window.getComputedStyle(el).propertyName")` for CSS assertions
- **Nav link display**: `.nav-menu a` uses `display: flex` (not block) for icon+text alignment — E2E test `SidebarLink_HasFlexDisplay` expects "flex"
- **Layout dimensions**: Sidebar 240px, top bar 64px, content max-width 1200px
- **Material Icons**: Loaded via Google Fonts CDN in `_Host.cshtml`; use `<span class="material-icons">icon_name</span>` in nav links
- **NuGet packages**: Main app uses `Z.Blazor.Diagrams` (not `Blazor.Diagrams`) v3.0.4; namespace is still `Blazor.Diagrams`. Radzen.Blazor resolves to 4.31.0.
- **Z.Blazor.Diagrams v3 API**: `Diagram` renamed to `BlazorDiagram`, `<BlazorDiagram>` component → `<DiagramCanvas BlazorDiagram="@diagram" />`, `GetDefaultPort()` removed — use `Ports.First(p => p.Alignment == ...)` instead
- **File upload**: Use standard Blazor `InputFile` with `InputFileChangeEventArgs` (not Radzen `RadzenFileInput`/`FileInputChangeEventArgs`)
- **IHedgingWizardViewModel.Step**: Has `{ get; set; }` — setter needed for `@bind-Value` in RadzenSteps
- **Design skill**: `.claude/skills/design/SKILL.md` — comprehensive design system tokens (colors, spacing, typography, components)
- **Wizard step numbering**: Steps 0-8 rendered via `Vm.Step switch` in HedgingWizard.razor; note steps 7/8 are Reporting/Booking (swapped from expected order)
- **Approval gate**: Approver rows found via exact text match + XPath ancestor::tr[1]; Approve button disabled after click confirms state change
- **Unit tests**: `dotnet test Pemberton.Shareclass.Hedging.Prototype/tests/Pemberton.Shareclass.Hedging.Prototype.Tests/`
- **E2E tests**: `dotnet test Pemberton.Shareclass.Hedging.Prototype/tests/Pemberton.Shareclass.Hedging.Prototype.UITests/`
- **Page header pattern**: Use `.page-header` > `h3.page-title` + `p.page-subtitle` for consistent page headers — CSS defined in app.css
- **Dashboard nav-card pattern**: `.nav-card` with `__icon`, `__title`, `__desc` — links rendered as `<a>` elements with href for E2E test compatibility (`article a[href='...']`)
- **Workflow pills**: `.workflow-pill` with category color classes (data-input, processing, approval, output) — reusable for step indicators
- **Color legend**: `.color-legend` with `__item`, `__swatch`, `__label` — category swatches reuse `.data-input`, `.processing`, `.approval`, `.output` classes
- **Hedge node link**: HedgeNode wraps content in `<a href="/wizard" class="hedge-node-link">` — nodes are clickable links to wizard
- **CSS connector lines**: `.workflow-cell::after` uses 2px background lines (not Unicode arrows) — hidden on responsive layouts via `display: none`
- **Responsive grid**: `.workflow-grid` uses media queries: 3 cols >900px, 2 cols 600-900px, 1 col <600px
- **Wizard action-bar**: `.action-bar` with `display: flex; justify-content: space-between` — Back left, Next right, border-top separator. Uses design tokens for spacing.
- **Wizard content area**: `.wizard-content` replaces Bootstrap `mt-4` — uses `margin-top: var(--space-6)` for step content spacing
- **Radzen Button Variant**: Use `Variant="Variant.Outlined"` for secondary buttons (Back), `ButtonStyle="ButtonStyle.Primary"` + `Icon` for primary actions (Next)

---
<!-- Iteration logs below — always append, never replace -->

## 2026-02-22 - US-001: Create the Professional Web Design AI Skill
- Created `.claude/skills/design/SKILL.md` with YAML frontmatter and all 8 required sections
- Fixed pre-existing doubled-quote corruption (`""` → `"`) across 18 source files (all .cs, .razor, .cshtml, .css)
- Fixed NuGet package: `Blazor.Diagrams` → `Z.Blazor.Diagrams` v3.0.4 (net8.0 target)
- Fixed .csproj files: doubled quotes in XML attributes
- Updated HedgingDiagram.razor for Z.Blazor.Diagrams v3 API (BlazorDiagram, DiagramCanvas, port lookup)
- Replaced `RadzenFileInput`/`Radzen.FileInputChangeEventArgs` with standard `InputFile`/`InputFileChangeEventArgs`
- Added `@using Microsoft.AspNetCore.Components.Forms` and `@using Microsoft.AspNetCore.Components.Routing` to _Imports.razor
- Made `IHedgingWizardViewModel.Step` settable (needed for `@bind-Value`)
- Files changed: 23 files (SKILL.md, 2 .csproj, 12 src .cs/.razor/.cshtml/.css, 3 test .cs, _Imports.razor, IHedgingWizardViewModel.cs, HedgingDiagram.razor)
- **Learnings for future iterations:**
  - The codebase on main had systematic doubled-quote corruption — all fixed now
  - Z.Blazor.Diagrams v3 has breaking API changes from v2 (Diagram→BlazorDiagram, different component names, removed GetDefaultPort)
  - Radzen 4.31 doesn't have `FileInputChangeEventArgs` — use standard Blazor `InputFileChangeEventArgs` instead
  - The `@bind-Value` on RadzenSteps requires a settable property on the interface

## 2026-02-23 - US-002: Establish CSS Design Token Foundation
- Added Google Fonts preconnect hints (`fonts.googleapis.com`, `fonts.gstatic.com`) and Inter font link (weights 400, 500, 600) to `_Host.cshtml`
- Created comprehensive `:root` block in `app.css` with all CSS custom properties from design skill: brand/accent colors, semantic colors, surfaces, category colors, text colors, spacing (--space-1 through --space-12), shadows, border radii
- Updated `body` font-family to `'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`
- Replaced all hardcoded hex values in `app.css`: sidebar bg → `var(--surface-sidebar)`, text → `var(--text-on-dark)`, active/hover color → `var(--color-accent)`, main bg → `var(--surface-body)`, topbar → `var(--surface-topbar)`, border → `var(--surface-border)`, border-radius → `var(--radius-sm)`
- Replaced all hardcoded values in `hedging.css`: grid gap/margin/padding → spacing tokens, arrow color → `var(--text-secondary)`, node padding/radius/gap → tokens, shadows → `var(--shadow-md)`/`var(--shadow-lg)`, category backgrounds → `var(--category-*)` tokens
- Updated `NavigationTests.cs`: `ActiveLink_HasHighlightColor` expects `rgb(14, 165, 233)` (was `rgb(97, 218, 251)`)
- Updated `DiagramPageTests.cs`: `Nodes_HaveCategoryBackgroundColors` expects new RGB values matching design tokens
- Files changed: `_Host.cshtml`, `app.css`, `hedging.css`, `NavigationTests.cs`, `DiagramPageTests.cs`
- **Learnings for future iterations:**
  - CSS variable values intentionally differ from old hardcoded values — E2E tests checking computed colors MUST be updated when design tokens change
  - The `:root` block is the single source of truth for all design tokens; future CSS should reference `var(--token)` exclusively
  - Resolved pre-existing merge conflict state on `prd.json` and `progress.txt` — files had unmerged status but no actual conflict markers

## 2026-02-23 - US-003: Redesign Layout Shell — Sidebar, Top Bar, Navigation
- Added nav-brand area to `NavMenu.razor` with 'Pemberton' title (20px, weight 600) and 'FX Hedging' subtitle (12px, uppercase, accent color)
- Added Material Icons to each nav link: home, account_tree, play_circle via `<span class="material-icons">`
- Updated `.nav-menu a` to `display: flex` with `align-items: center` and `gap: var(--space-3)` for icon+text alignment
- Nav items padding updated to use design tokens (`var(--space-1)` vertical, `var(--space-3)` horizontal)
- Added `.material-icons` opacity styling (0.7 default, 1.0 on hover/active)
- Updated sidebar width from 220px to 240px
- Top bar: height 64px, display:flex, align-items:center, padding via tokens, h2 styled (16px/600)
- Content area: max-width 1200px, margin:0 auto, padding via tokens
- Removed `px-4` Bootstrap utility class from MainLayout.razor (top-row and content)
- Added SVG data URI favicon (navy rounded rect with white P letter) to `_Host.cshtml`
- Updated `NavigationTests.cs`: renamed `SidebarLink_HasBlockDisplay` → `SidebarLink_HasFlexDisplay`, expects "flex"
- Files changed: `NavMenu.razor`, `MainLayout.razor`, `app.css`, `_Host.cshtml`, `NavigationTests.cs`
- **Learnings for future iterations:**
  - Changing nav link display from `block` to `flex` requires updating the corresponding E2E test assertion
  - Bootstrap utility classes (px-4) should be replaced with design-token-based CSS, not just removed — use padding in the CSS rules
  - The `.top-row h2` element must remain for `HomePage_TopRowShowsAppTitle` E2E test (checks for "Pemberton" text)

## 2026-02-23 - US-004: Redesign Home Page as Professional Dashboard Landing
- Replaced bare h3 + ul/li home page with professional dashboard layout
- Added page-header with h3.page-title 'FX Hedging Dashboard' and p.page-subtitle
- Created 2-column .dashboard-grid with two .nav-card elements: Diagram (account_tree icon, links to /diagram) and Wizard (play_circle icon, links to /wizard)
- Added .workflow-overview section with 9 category-colored .workflow-pill elements showing all steps
- Added CSS classes to app.css: .page-header, .page-title, .page-subtitle, .dashboard-grid, .nav-card (with __icon, __title, __desc), .workflow-overview, .workflow-pill (with __index, __label)
- Updated HomePageTests.cs: HomePage_HasExpectedHeading now expects 'FX Hedging Dashboard'
- Nav-cards use `<a>` tags directly so `article a[href='diagram']` and `article a[href='wizard']` selectors work for E2E tests
- Also committed pre-existing csproj cleanup (TreatWarningsAsErrors, Radzen 4.31.0, removed duplicate Project line)
- Files changed: `Index.razor`, `app.css`, `HomePageTests.cs`, `.csproj`
- **Learnings for future iterations:**
  - E2E test `HomePage_HasLinksToWizardAndDiagram` expects `article a[href='diagram']` — the nav-card links must be `<a>` elements (not NavLink wrapped in div) directly inside the `article.content` container
  - The .page-header/.page-title pattern is reusable for all page redesigns (US-005, US-006, etc.)
  - No inline styles needed — all dashboard styling achieved through CSS classes using design tokens

## 2026-02-23 - US-005: Redesign Hedging Diagram Page
- Replaced DiagramCanvas (Z.Blazor.Diagrams) with custom workflow grid using HedgeNode components rendered via `Vm.WorkflowSteps`
- Added page-header with h3.page-title 'Hedging Workflow' and p.page-subtitle '9-step share-class FX hedging process'
- Replaced Unicode arrow pseudo-elements (`\2192`, `\2193`) with CSS-drawn 2px connector lines using `background: var(--text-secondary)`
- Added color-legend section below grid with four category swatches (Data Input, Processing, Approval, Output)
- Wrapped HedgeNode content in clickable `<a href="/wizard" class="hedge-node-link">` element
- Added `.hedge-node-link` CSS (text-decoration:none, color:inherit, display:block)
- Made grid responsive: 3 cols >900px, 2 cols 600-900px, 1 col <600px via media queries; connectors hidden on smaller layouts
- Updated DiagramPageTests.cs: heading expects 'Hedging Workflow' (was 'Hedging Workflow Diagram')
- Updated NavigationTests.cs: diagram heading expects 'Hedging Workflow'
- Removed Z.Blazor.Diagrams `@using` directives and DiagramCanvas code from HedgingDiagram.razor
- Files changed: `HedgingDiagram.razor`, `HedgeNode.razor`, `hedging.css`, `DiagramPageTests.cs`, `NavigationTests.cs`
- **Learnings for future iterations:**
  - The diagram page originally used Z.Blazor.Diagrams DiagramCanvas but E2E tests expected custom `.workflow-grid`/`.hedge-node` elements — the custom grid approach is the correct one
  - Wrapping components in `<a>` elements doesn't break existing E2E locators (`.hedge-node` still matched inside the link)
  - CSS connector lines are cleaner than Unicode arrows — use `content: ""` with width/height/background instead of text-based arrows
  - Responsive layouts should hide connectors on breakpoints where grid columns change (connectors assume specific column positions)

## 2026-02-23 - US-006: Redesign Wizard Navigation and Step Indicator
- Added page-header with h3.page-title 'Execution Wizard' and p.page-subtitle 'Step through the FX hedging workflow'
- Replaced `<div class="mt-4">` with `<div class="wizard-content">` using design-token spacing
- Replaced `<div class="mt-3">` with `<div class="action-bar">` — flex layout with border-top, Back left-aligned, Next right-aligned
- Back button: added `Variant="Variant.Outlined"` and `Icon="arrow_back"`, removed `Style="margin-right:10px"`
- Next button: kept `ButtonStyle="ButtonStyle.Primary"`, added `Icon="arrow_forward"`
- Added `.wizard-content` and `.action-bar` CSS classes to app.css using design tokens (--space-6, --surface-border)
- Updated WizardPageTests.cs: `WizardPage_HasExpectedHeading` expects 'Execution Wizard'
- Updated NavigationTests.cs: `ClickingWizardLink_NavigatesToWizardPage` expects 'Execution Wizard'
- Files changed: `HedgingWizard.razor`, `app.css`, `WizardPageTests.cs`, `NavigationTests.cs`
- **Learnings for future iterations:**
  - `Variant.Outlined` is the Radzen way to make a secondary/ghost button — cleaner than custom CSS
  - The `Icon` parameter on RadzenButton renders a Material Icon inside the button automatically
  - Bootstrap utility classes (mt-3, mt-4) should be replaced with semantic CSS classes using design tokens, not just swapped for other utilities
  - The approval step (step 5) still has inline `Style="margin-right:10px"` on the Approve button — this is US-009's scope
