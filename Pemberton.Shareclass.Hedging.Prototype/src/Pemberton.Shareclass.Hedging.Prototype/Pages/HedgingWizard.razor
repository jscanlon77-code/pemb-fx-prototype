@page "/wizard"
@page "/wizard"
@inject IHedgingWizardViewModel Vm

<h3>Hedging Execution Wizard</h3>

<RadzenSteps @bind-Value="Vm.Step" ShowStepsButtons="false">
    <Steps>
        <RadzenStepsItem Text="BNY Data" />
        <RadzenStepsItem Text="Record FX Data" />
        <RadzenStepsItem Text="Validation" />
        <RadzenStepsItem Text="Calculation" />
        <RadzenStepsItem Text="Trade Instructions" />
        <RadzenStepsItem Text="Approvals" />
        <RadzenStepsItem Text="Execution" />
        <RadzenStepsItem Text="Booking" />
        <RadzenStepsItem Text="Reporting" />
    </Steps>
</RadzenSteps>

<div class="mt-4">
    @RenderStep()
</div>

<div class="mt-3">
    <RadzenButton Text="Back" Click="() => Vm.Back()" Disabled="Vm.IsFirst" Style="margin-right:10px" />
    <RadzenButton Text="Next" Click="() => Vm.Next()" Disabled="Vm.IsLast" ButtonStyle="ButtonStyle.Primary" />
</div>

@code {
    RenderFragment RenderStep() => Vm.Step switch
    {
        0 => @<div>
            <h4>BNY Data (Share Class Exposure)</h4>
            <label>Upload BNY CSV:</label>
            <InputFile OnChange="OnBnyCsvUpload" />
            <RadzenDataGrid Data="@Vm.PivotedBnyData" TItem="IDictionary<string, object>">
                <Columns>
                    @if (Vm.PivotedBnyData.Any())
                    {
                        foreach (var col in Vm.PivotedBnyData.First().Keys)
                        {
                            <RadzenDataGridColumn TItem="IDictionary<string, object>" Property="@col" Title="@col" />
                        }
                    }
                </Columns>
            </RadzenDataGrid>
        </div>,
        1 => @<div>
            <h4>Record FX Data</h4>
            <label>Upload FX CSV:</label>
            <InputFile OnChange="OnFxCsvUpload" />
            <RadzenDataGrid Data="@Vm.PivotedFxData" TItem="IDictionary<string, object>">
                <Columns>
                    @if (Vm.PivotedFxData.Any())
                    {
                        foreach (var col in Vm.PivotedFxData.First().Keys)
                        {
                            <RadzenDataGridColumn TItem="IDictionary<string, object>" Property="@col" Title="@col" />
                        }
                    }
                </Columns>
            </RadzenDataGrid>
        </div>,
        2 => @<p>Validation: @(Vm.FxData.Any() && Vm.BnyData.Any() ? "OK" : "Pending")</p>,
        3 => @<p>Calculated @Vm.Instructions?.Count hedge instructions.</p>,
        4 => @<p>Trade instructions ready for approval.</p>,
        5 => @<div>
            <h4>Approvals</h4>
            <RadzenDataGrid Data="@Vm.Approvals" TItem="ApproverStatus">
                <Columns>
                    <RadzenDataGridColumn TItem="ApproverStatus" Property="ApproverName" Title="Approver" />
                    <RadzenDataGridColumn TItem="ApproverStatus" Property="Status" Title="Status" />
                    <RadzenDataGridColumn TItem="ApproverStatus" Title="Actions">
                        <Template Context="a">
                            <RadzenButton Text="Approve"      Disabled="@(a.Status != "Pending")"
                                          Click="async () => await Vm.ApproveAsync(a.ApproverName)"    Style="margin-right:10px" />
                            <RadzenButton Text="Reject"                      Disabled="@(a.Status != "Pending")"                                 ButtonStyle="ButtonStyle.Danger"
                                          Click="async () => await Vm.RejectAsync(a.ApproverName)" />
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>

            @if (!Vm.AllApproved)
            {
                <p style="color:red;margin-top:10px;">
                    All four approvals are required before continuing.
                </p>
            }
        </div>,
        6 => @<p>@Vm.ExecutionResult</p>,
        7 => @<div>
            <h4>Reporting</h4>
            @if (Vm.ReportingData is not null)
            {
                <ul>
                    @foreach (var item in Vm.ReportingData)
                    {
                        <li>@item</li>
                    }
                </ul>
            }
            else
            {
                <p>No reporting data loaded.</p>
            }
        </div>,
        8 => @<p>Movements booked (mock API).</p>,
        _ => @<p>Select a step.</p>
        };

    async Task OnBnyCsvUpload(InputFileChangeEventArgs args)
    {
        if (args.FileCount > 0)
           {
           await Vm.LoadBnyCsvAsync(args.File.OpenReadStream());
        }
    }

async Task OnFxCsvUpload(InputFileChangeEventArgs args)
{
    if (args.FileCount > 0)
    {
        await Vm.LoadFxCsvAsync(args.File.OpenReadStream());
    }
}
}