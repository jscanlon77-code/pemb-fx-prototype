@page "/wizard"
@page "/wizard"
@inject IHedgingWizardViewModel Vm

<div class="page-header">
    <h3 class="page-title">Execution Wizard</h3>
    <p class="page-subtitle">Step through the FX hedging workflow</p>
</div>

<RadzenSteps @bind-Value="Vm.Step" ShowStepsButtons="false">
    <Steps>
        <RadzenStepsItem Text="BNY Data" />
        <RadzenStepsItem Text="Record FX Data" />
        <RadzenStepsItem Text="Validation" />
        <RadzenStepsItem Text="Calculation" />
        <RadzenStepsItem Text="Trade Instructions" />
        <RadzenStepsItem Text="Approvals" />
        <RadzenStepsItem Text="Execution" />
        <RadzenStepsItem Text="Booking" />
        <RadzenStepsItem Text="Reporting" />
    </Steps>
</RadzenSteps>

<div class="wizard-content">
    @RenderStep()
</div>

<div class="action-bar">
    <RadzenButton Text="Back" Click="() => Vm.Back()" Disabled="Vm.IsFirst" Variant="Variant.Outlined" Icon="arrow_back" />
    <RadzenButton Text="Next" Click="() => Vm.Next()" Disabled="Vm.IsLast" ButtonStyle="ButtonStyle.Primary" Icon="arrow_forward" />
</div>

@code {
    RenderFragment RenderStep() => Vm.Step switch
    {
        0 => @<div>
            <p class="step-context">Step 1 of 9</p>
            <h4>BNY Data (Share Class Exposure)</h4>
            <div class="upload-zone">
                <span class="material-icons upload-zone__icon">cloud_upload</span>
                <p class="upload-zone__text">Drop a CSV file here or click to browse</p>
                <InputFile OnChange="OnBnyCsvUpload" />
            </div>
            @if (Vm.BnyData.Any())
            {
                <div class="upload-success">
                    <span class="material-icons upload-success__icon">check_circle</span>
                    <span class="upload-success__text">@Vm.BnyData.Count records loaded</span>
                </div>
                <RadzenDataGrid Data="@Vm.PivotedBnyData" TItem="IDictionary<string, object>">
                    <Columns>
                        @if (Vm.PivotedBnyData.Any())
                        {
                            foreach (var col in Vm.PivotedBnyData.First().Keys)
                            {
                                <RadzenDataGridColumn TItem="IDictionary<string, object>" Property="@col" Title="@col" />
                            }
                        }
                    </Columns>
                </RadzenDataGrid>
            }
            else
            {
                <div class="empty-state">
                    <span class="material-icons empty-state__icon">description</span>
                    <p class="empty-state__heading">No data uploaded</p>
                    <p class="empty-state__desc">Upload a CSV file to begin</p>
                </div>
            }
        </div>,
        1 => @<div>
            <p class="step-context">Step 2 of 9</p>
            <h4>Record FX Data</h4>
            <div class="upload-zone">
                <span class="material-icons upload-zone__icon">cloud_upload</span>
                <p class="upload-zone__text">Drop a CSV file here or click to browse</p>
                <InputFile OnChange="OnFxCsvUpload" />
            </div>
            @if (Vm.FxData.Any())
            {
                <div class="upload-success">
                    <span class="material-icons upload-success__icon">check_circle</span>
                    <span class="upload-success__text">@Vm.FxData.Count records loaded</span>
                </div>
                <RadzenDataGrid Data="@Vm.PivotedFxData" TItem="IDictionary<string, object>">
                    <Columns>
                        @if (Vm.PivotedFxData.Any())
                        {
                            foreach (var col in Vm.PivotedFxData.First().Keys)
                            {
                                <RadzenDataGridColumn TItem="IDictionary<string, object>" Property="@col" Title="@col" />
                            }
                        }
                    </Columns>
                </RadzenDataGrid>
            }
            else
            {
                <div class="empty-state">
                    <span class="material-icons empty-state__icon">description</span>
                    <p class="empty-state__heading">No data uploaded</p>
                    <p class="empty-state__desc">Upload a CSV file to begin</p>
                </div>
            }
        </div>,
        2 => @<p>Validation: @(Vm.FxData.Any() && Vm.BnyData.Any() ? "OK" : "Pending")</p>,
        3 => @<p>Calculated @Vm.Instructions?.Count hedge instructions.</p>,
        4 => @<p>Trade instructions ready for approval.</p>,
        5 => @<div>
            <h4>Approvals</h4>
            <RadzenDataGrid Data="@Vm.Approvals" TItem="ApproverStatus">
                <Columns>
                    <RadzenDataGridColumn TItem="ApproverStatus" Property="ApproverName" Title="Approver" />
                    <RadzenDataGridColumn TItem="ApproverStatus" Property="Status" Title="Status" />
                    <RadzenDataGridColumn TItem="ApproverStatus" Title="Actions">
                        <Template Context="a">
                            <RadzenButton Text="Approve"      Disabled="@(a.Status != "Pending")"
                                          Click="async () => await Vm.ApproveAsync(a.ApproverName)"    Style="margin-right:10px" />
                            <RadzenButton Text="Reject"                      Disabled="@(a.Status != "Pending")"                                 ButtonStyle="ButtonStyle.Danger"
                                          Click="async () => await Vm.RejectAsync(a.ApproverName)" />
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>

            @if (!Vm.AllApproved)
            {
                <p style="color:red;margin-top:10px;">
                    All four approvals are required before continuing.
                </p>
            }
        </div>,
        6 => @<p>@Vm.ExecutionResult</p>,
        7 => @<div>
            <h4>Reporting</h4>
            @if (Vm.ReportingData is not null)
            {
                <ul>
                    @foreach (var item in Vm.ReportingData)
                    {
                        <li>@item</li>
                    }
                </ul>
            }
            else
            {
                <p>No reporting data loaded.</p>
            }
        </div>,
        8 => @<p>Movements booked (mock API).</p>,
        _ => @<p>Select a step.</p>
        };

    async Task OnBnyCsvUpload(InputFileChangeEventArgs args)
    {
        if (args.FileCount > 0)
           {
           await Vm.LoadBnyCsvAsync(args.File.OpenReadStream());
        }
    }

async Task OnFxCsvUpload(InputFileChangeEventArgs args)
{
    if (args.FileCount > 0)
    {
        await Vm.LoadFxCsvAsync(args.File.OpenReadStream());
    }
}
}